# 出来高急増ランキングシステム

上海A株、科創板、新三板（北交所含む）の出来高急増銘柄を検出し、ランキングを生成するシステムです。

## モジュール構成

このシステムは以下の6つのモジュールで構成されています：

### 1. `config.py` - 設定と定数
- **役割**: システム全体で使用する設定値と定数を定義
- **主な内容**:
  - ディレクトリ設定（`DATA_DIR`, `OUTPUT_DIR`）
  - 分析パラメータ（`MA_WINDOW`, `VOL_MULTIPLE`, `MIN_PCT_CHG`, `MIN_AMOUNT`, `Z_THRESHOLD`, `STD_FLOOR`）
  - 日付設定（`TODAY`, `DEFAULT_START`）
  - ファイルパス（`STOCK_LIST_PATH`）

### 2. `stock_list.py` - 銘柄リスト取得関連
- **役割**: 銘柄リストの取得と管理
- **主な関数**:
  - `get_stock_list()`: 銘柄リストの取得と管理（保存済みリストがあれば使用、なければ取得して保存）
  - `get_stocks_from_api()`: APIから上海A株、科創板、新三板（北交所含む）の銘柄リストを取得
  - `get_xsb_stocks_only()`: 新三板（北交所含む）のみの銘柄リストを取得

### 3. `data_loader.py` - データ取得・ダウンロード関連
- **役割**: 個別銘柄のデータ取得とダウンロード
- **主な関数**:
  - `load_or_download(code, latest_trading_date=None)`: メインのデータ取得関数
    - 既存CSVがあれば不足分だけダウンロードして追記
    - ネットワークエラー時は既存データを返す
    - 既存データが古い（2日以上前）場合は、より広い期間で取得を試みる
  - `get_latest_trading_date(stocks)`: サンプル銘柄で最新の取引日を確認
- **内部補助関数**:
  - `_load_existing_data()`: 既存データの読み込みと日付の正規化
  - `_check_if_update_needed()`: 更新が必要かチェック
  - `_determine_start_date()`: 開始日の決定
  - `_fetch_stock_data()`: akshareからデータを取得
  - `_merge_and_save_data()`: データ結合と保存
  - `_handle_date_type_error()`: 日付型エラーの処理

### 4. `volume_analyzer.py` - 出来高急増検知関連
- **役割**: 出来高急増の検知と分析
- **主な関数**:
  - `detect_volume_spike(df, target_date_str=None)`: 出来高急増の検知
    - 倍率法（`VOL_MULTIPLE`倍以上）とZ-score法（`Z_THRESHOLD`以上）の両方に対応
    - 指定日のデータでランキングを計算（`target_date_str`が指定された場合）
    - 共通フィルタ: 漲跌幅3%以上、9.5%未満、成交额1億以上
  - `calc_forward_return(df, days)`: 最新日からdays後の終値リターン計算

### 5. `output.py` - 出力・表示関連
- **役割**: 結果の表示とCSV保存
- **主な関数**:
  - `print_data_acquisition_summary()`: データ取得状況のサマリー表示
  - `save_failed_stocks()`: 失敗した銘柄の情報を表示してCSVに保存
  - `save_old_data_stocks()`: 古いデータ（2日以上前）の銘柄の情報を表示してCSVに保存
  - `retry_failed_stocks()`: 失敗した銘柄の再試行（ユーザー入力あり）
  - `save_ranking_results()`: ランキング結果をCSVに保存して表示

### 6. `main.py` - メイン処理
- **役割**: 各モジュールを統合してメイン処理を実行
- **主な処理**:
  1. 銘柄リストの取得
  2. 最新取引日の確認
  3. 各銘柄のデータ取得と出来高急増検知
  4. 統計情報の収集（銘柄タイプ別の処理統計を含む）
  5. 結果の表示と保存

## 実行方法

### 基本的な実行

```bash
python main.py
```

### 実行の流れ

1. **銘柄リストの取得**
   - 保存済みの銘柄リストがあれば読み込み
   - なければAPIから取得して保存
   - バックグラウンドで最新リストを取得して更新

2. **最新取引日の確認**
   - サンプル銘柄で最新の取引日を確認
   - 今日が取引日でない場合は、最新の取引日を使用

3. **データ取得と分析**
   - 各銘柄について：
     - 既存データがあれば不足分だけダウンロード
     - 最新取引日のデータで出来高急増を検知
     - 条件を満たす銘柄をランキングに追加

4. **結果の表示と保存**
   - データ取得状況のサマリー表示
   - 失敗した銘柄のリスト表示と保存
   - 古いデータの銘柄のリスト表示と保存
   - ランキング結果の表示とCSV保存

### 出力ファイル

- `data/daily/stock_list_sh_xsb.csv`: 銘柄リスト
- `data/daily/{code}.csv`: 各銘柄の日次データ
- `output/volume_spike_ratio_rank.csv`: 倍率法によるランキング
- `output/volume_spike_z_rank.csv`: Z-score法によるランキング
- `output/failed_stocks.csv`: データ取得に失敗した銘柄リスト
- `output/old_data_stocks.csv`: 古いデータ（2日以上前）の銘柄リスト
- `output/retry_failed_stocks.csv`: 再試行後も失敗した銘柄リスト（再試行を実行した場合）

## 設定パラメータ

`config.py`で以下のパラメータを調整できます：

- `MA_WINDOW = 20`: 移動平均の期間（日数）
- `VOL_MULTIPLE = 2.0`: 出来高倍率の閾値（平均の2倍以上）
- `MIN_PCT_CHG = 3.0`: 最小漲跌幅（%）
- `MIN_AMOUNT = 1e8`: 最小成交额（1億）
- `Z_THRESHOLD = 2.5`: Z-scoreの閾値
- `STD_FLOOR = 1e-6`: 標準偏差の下限値（分散ゼロ対策）

## 対応銘柄

- **上海A株**: 60で始まるコード（例: 600000, 600001）
- **科創板**: 68で始まるコード（例: 688001, 688002）
- **新三板（北交所含む）**: 
  - 43で始まるコード（基礎層）
  - 83で始まるコード（創新層）
  - 87で始まるコード（精選層）
  - 8で始まるコード（北交所）
  - 9で始まるコード（北交所）

## 注意事項

- 初回実行時は全銘柄のデータをダウンロードするため、時間がかかります
- ネットワークエラーが発生した場合、既存データを使用します
- 最新取引日のデータがない銘柄はランキングに含まれません
- 失敗した銘柄は再試行オプションで再取得を試みることができます

## 依存ライブラリ

- `akshare`: 中国株式データの取得
- `pandas`: データ処理
- `tqdm`: プログレスバー表示

## ライセンス

このプロジェクトは個人利用を目的としています。

